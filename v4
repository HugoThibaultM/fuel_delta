import urllib.request
import json
import time

# URL de SimHub
URL = "http://127.0.0.1:8888/api/getgamedata"

def rastrear_valor_profundo(data, objetivo, ruta_actual=""):
    """Busca recursivamente un valor num√©rico dentro del JSON de SimHub"""
    found_paths = []
    
    if isinstance(data, dict):
        for k, v in data.items():
            nuevaruta = f"{ruta_actual}.{k}" if ruta_actual else k
            found_paths.extend(rastrear_valor_profundo(v, objetivo, nuevaruta))
    elif isinstance(data, list):
        for i, v in enumerate(data):
            nuevaruta = f"{ruta_actual}[{i}]"
            found_paths.extend(rastrear_valor_profundo(v, objetivo, nuevaruta))
    elif isinstance(data, (int, float)):
        # Comparamos con un margen de error peque√±o (0.1)
        if abs(data - objetivo) < 0.1:
            found_paths.append((ruta_actual, data))
            
    return found_paths

def main():
    print("--- RASTREADOR PROFUNDO DE SIMHUB ---")
    print("Este script preguntar√° a SimHub d√≥nde tiene escondido el dato.")
    
    try:
        objetivo_str = input("\nIntroduce los LITROS que ves en SimHub (ej. 92.8): ")
        objetivo = float(objetivo_str.replace(',', '.'))
        print(f"‚è≥ Preguntando a SimHub por el valor {objetivo}...")
        
        with urllib.request.urlopen(URL, timeout=2) as response:
            if response.getcode() == 200:
                raw_json = response.read().decode()
                data = json.loads(raw_json)
                
                # Buscamos en todo el √°rbol de datos
                resultados = rastrear_valor_profundo(data, objetivo)
                
                if resultados:
                    print("\n‚úÖ ¬°ENCONTRADO! SimHub guarda ese dato aqu√≠:")
                    print("-" * 60)
                    for ruta, valor in resultados:
                        print(f"üìç RUTA: {ruta}")
                        print(f"   Valor exacto: {valor}")
                        print("-" * 60)
                    
                    print("\nüëá COPIA LA 'RUTA' Y D√ÅMELA PARA HACER TU SCRIPT FINAL.")
                else:
                    print("\n‚ùå SimHub no nos ha dado ese n√∫mero en su API p√∫blica.")
                    print("   Intenta buscar otro valor (ej. las RPM) para ver si conecta.")
                    
    except ValueError:
        print("‚ùå Error: Introduce un n√∫mero v√°lido (usa punto para decimales).")
    except Exception as e:
        print(f"‚ùå Error conectando a SimHub: {e}")

if __name__ == "__main__":
    main()
