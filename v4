import urllib.request
import json
import time
import os

# --- CONFIGURACIÃ“N ---
SIMHUB_URL = "http://127.0.0.1:8888/api/getgamedata"
CAPACIDAD_DEPOSITO = 100.0  # Ajusta esto segÃºn el coche (Hypercar ~100L, LMP2 ~75L)

class MonitorCombustible:
    def __init__(self):
        self.fuel_history = []
        self.last_fuel = 0.0
        self.laps_completed = 0
        self.start_fuel_lap = 0.0
        self.consumo_medio = 0.0
        self.vueltas_restantes = 0.0

    def limpiar_pantalla(self):
        os.system('cls' if os.name == 'nt' else 'clear')

    def obtener_datos(self):
        try:
            with urllib.request.urlopen(SIMHUB_URL, timeout=0.5) as response:
                if response.getcode() == 200:
                    raw_data = json.loads(response.read().decode())
                    
                    # --- AQUÃ ESTÃ LA MAGIA ---
                    # Usamos la ruta exacta que encontrÃ³ tu rastreador
                    new_data = raw_data.get('NewData', {})
                    
                    datos = {
                        'fuel': new_data.get('Fuel', 0.0),
                        'rpm': new_data.get('Rpms', 0),
                        'gear': new_data.get('Gear', 'N'),
                        'lap': new_data.get('CurrentLap', 0),
                        'en_pista': raw_data.get('GameRunning', False)
                    }
                    return datos
        except Exception:
            return None
        return None

    def calcular_consumo(self, datos):
        current_fuel = datos['fuel']
        current_lap = datos['lap']

        # Si cambiamos de vuelta, calculamos cuÃ¡nto gastamos en la anterior
        if current_lap > self.laps_completed:
            if self.start_fuel_lap > 0:
                consumo_vuelta = self.start_fuel_lap - current_fuel
                # Filtramos consumos irreales (ej. si repostas, el consumo sale negativo)
                if consumo_vuelta > 0.5: 
                    self.fuel_history.append(consumo_vuelta)
                    
                    # Calculamos media de las Ãºltimas 5 vueltas
                    historial_reciente = self.fuel_history[-5:]
                    self.consumo_medio = sum(historial_reciente) / len(historial_reciente)

            # Reseteamos para la nueva vuelta
            self.laps_completed = current_lap
            self.start_fuel_lap = current_fuel

        # Si es la primera vez que leemos, guardamos referencia
        if self.start_fuel_lap == 0 and current_fuel > 0:
            self.start_fuel_lap = current_fuel
            self.laps_completed = current_lap

        # Calculamos vueltas restantes
        if self.consumo_medio > 0:
            self.vueltas_restantes = current_fuel / self.consumo_medio
        else:
            self.vueltas_restantes = 0

    def mostrar_interfaz(self, datos):
        self.limpiar_pantalla()
        print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
        print("â•‘       MONITOR LMU (VÃA SIMHUB)           â•‘")
        print("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
        
        if not datos or not datos['en_pista']:
            print("â•‘  â³ ESPERANDO A SIMHUB / JUEGO...        â•‘")
            print("â•‘  (AsegÃºrate de estar en pista)           â•‘")
        else:
            # Barra de RPM visual
            rpm_perc = min(1.0, datos['rpm'] / 9000) # Asumiendo 9000 max
            bar_len = 20
            bar_fill = int(rpm_perc * bar_len)
            rpm_bar = "â–ˆ" * bar_fill + "â–‘" * (bar_len - bar_fill)

            print(f"â•‘ ğŸï¸  RPM: {datos['rpm']:.0f} [{rpm_bar}]   â•‘")
            print(f"â•‘ âš™ï¸  MARCHA: {datos['gear']}                        â•‘")
            print("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
            print(f"â•‘ â›½ COMBUSTIBLE ACTUAL:  {datos['fuel']:>6.2f} L      â•‘")
            print(f"â•‘ ğŸ“‰ CONSUMO ÃšLT. VUELTA: {self.fuel_history[-1] if self.fuel_history else 0:>6.2f} L      â•‘")
            print(f"â•‘ ğŸ“Š CONSUMO MEDIO:       {self.consumo_medio:>6.2f} L      â•‘")
            print("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
            
            if self.vueltas_restantes > 0:
                print(f"â•‘ ğŸ VUELTAS RESTANTES:   {self.vueltas_restantes:>6.1f}        â•‘")
            else:
                print("â•‘ ğŸ VUELTAS RESTANTES:   CALCULANDO...    â•‘")
                
        print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        print("  Pulsa Ctrl+C para salir")

    def ejecutar(self):
        print("Iniciando monitor...")
        try:
            while True:
                datos = self.obtener_datos()
                if datos and datos['en_pista']:
                    self.calcular_consumo(datos)
                
                self.mostrar_interfaz(datos)
                time.sleep(0.5) # Actualizamos cada medio segundo
        except KeyboardInterrupt:
            print("\nMonitor detenido.")

if __name__ == "__main__":
    app = MonitorCombustible()
    app.ejecutar()
