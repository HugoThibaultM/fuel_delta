import mmap
import struct

def buscar_aguja_en_pajar():
    print("--- BUSCADOR DE OFFSET DE COMBUSTIBLE ---")
    print("Este script escanear√° la memoria buscando el valor exacto que ves en SimHub.")
    
    # 1. Preguntamos al usuario qu√© valor buscar
    try:
        target_str = input("\nIntroduce los LITROS exactos que ves en SimHub (ej. 92.8): ")
        target_val = float(target_str.replace(',', '.')) # Aceptamos coma o punto
    except ValueError:
        print("‚ùå Por favor, introduce un n√∫mero v√°lido.")
        return

    print(f"\nüîç Buscando el valor {target_val} (+/- 0.1) en la memoria...")

    # Lista de mapas donde SimHub suele escribir
    mapas = ["$rFactor2Shared$", "$rFactor2SMMP_Telemetry$", "Local\\$rFactor2Shared$"]
    
    encontrado_algo = False

    for nombre_mapa in mapas:
        try:
            shmem = mmap.mmap(-1, 64000, nombre_mapa, access=mmap.ACCESS_READ)
            shmem.seek(0)
            data = shmem.read(64000) # Leemos todo el bloque de golpe
            
            print(f"   üìÇ Analizando mapa: {nombre_mapa}...")
            
            # Escaneamos byte a byte (esto es fuerza bruta)
            # El combustible es un 'double' (8 bytes) o 'float' (4 bytes)
            
            for i in range(0, 500, 4): # Buscamos solo en los primeros 500 bytes para no tardar
                try:
                    # Prueba 1: ¬øEs un Double (8 bytes)? (Formato standard rFactor2)
                    val_double = struct.unpack('d', data[i:i+8])[0]
                    if abs(val_double - target_val) < 0.1: # Margen de error peque√±o
                        print(f"\n‚úÖ ¬°EUREKA! Encontrado (Double) en offset {i}")
                        print(f"   -> Mapa: {nombre_mapa}")
                        print(f"   -> Valor en memoria: {val_double:.4f}")
                        print(f"   -> SOLUCI√ìN: En tu script, cambia el offset de Fuel a {i}")
                        encontrado_algo = True
                        
                    # Prueba 2: ¬øEs un Float (4 bytes)? (Formato antiguo o UDP convertido)
                    val_float = struct.unpack('f', data[i:i+4])[0]
                    if abs(val_float - target_val) < 0.1:
                        print(f"\n‚úÖ ¬°EUREKA! Encontrado (Float) en offset {i}")
                        print(f"   -> Mapa: {nombre_mapa}")
                        print(f"   -> Valor en memoria: {val_float:.4f}")
                        print(f"   -> SOLUCI√ìN: Es un float en offset {i}")
                        encontrado_algo = True
                        
                except:
                    pass
            
            shmem.close()
            
        except FileNotFoundError:
            pass

    if not encontrado_algo:
        print("\n‚ùå No se encontr√≥ el valor.")
        print("   1. Aseg√∫rate de poner el n√∫mero EXACTO (con decimales).")
        print("   2. Aseg√∫rate de ejecutar este script como ADMINISTRADOR.")
        print("   3. Si SimHub ve 92.8, prueba a buscar 92.0 o 93.0 por si redondea.")

if __name__ == "__main__":
    buscar_aguja_en_pajar()
