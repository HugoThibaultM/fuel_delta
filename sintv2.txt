"""
Le Mans Ultimate - Monitor de Combustible (Versión Auto-Detect)
Monitoriza el consumo conectándose automáticamente al mapa de memoria activo (SimHub/LMU/rF2)
"""

import mmap
import ctypes
import time
import struct
from dataclasses import dataclass
from typing import Optional
from config import Config
from calculator import FuelCalculator
from display import Display

# ==========================================
# ESTRUCTURAS DE DATOS (Mapeo de Memoria)
# ==========================================

# Estructura de Telemetría Standard (rFactor 2 / LMU)
class rF2VehicleTelemetry(ctypes.Structure):
    _pack_ = 4
    _fields_ = [
        ("mID", ctypes.c_int),                  # 0
        ("mDeltaTime", ctypes.c_double),        # 4
        ("mEngineRPM", ctypes.c_double),        # 12
        ("mEngineWaterTemp", ctypes.c_double),  # 20
        ("mEngineOilTemp", ctypes.c_double),    # 28
        ("mClutchRPM", ctypes.c_double),        # 36
        ("mUnfilteredThrottle", ctypes.c_double), # 44
        ("mUnfilteredBrake", ctypes.c_double),    # 52
        ("mUnfilteredSteering", ctypes.c_double), # 60
        ("mUnfilteredClutch", ctypes.c_double),   # 68
        ("mSteeringArmForce", ctypes.c_double),   # 76
        ("mFuel", ctypes.c_double),               # 84 <--- DATO CLAVE
        ("mEngineMaxRPM", ctypes.c_double),       # 92
        ("mScheduledStops", ctypes.c_byte),
        ("mOverheating", ctypes.c_byte),
        ("mDetached", ctypes.c_byte),
        ("mHeadlights", ctypes.c_byte),
        ("mPadding", ctypes.c_byte * 4)
    ]

class rF2Telemetry(ctypes.Structure):
    _fields_ = [
        ("mVersionUpdateBegin", ctypes.c_uint),
        ("mVersionUpdateEnd", ctypes.c_uint),
        ("mLoadSessionBegin", ctypes.c_int),
        ("mLoadSessionEnd", ctypes.c_int),
        ("mNumVehicles", ctypes.c_int),
        ("mVehicles", rF2VehicleTelemetry * 64)
    ]

# Estructura simplificada para Scoring (Solo cabecera para tiempos)
class rF2ScoringInfo(ctypes.Structure):
    _pack_ = 4
    _fields_ = [
        ("mTrackName", ctypes.c_char * 64),
        ("mSession", ctypes.c_int),
        ("m
